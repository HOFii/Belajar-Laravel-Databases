# LARAVEL DATABASE

## POINT UTAMA

### 1. Instalasi

-   Minimal PHP versi 8 atau lebih,

-   Composer versi 2 atau lebih,

-   Lalu pada cmd ketikan `composer create-project laravel/laravel=v10.2.3 belajar-laravel-database`.

---

### 2. Laravel Database

-   Semua konfigurasi database di Laravel di simpan didalam directory `config/database.php`.

---

### 3. Membuat database

-   Buat database menggunakan MySQL dengan nama `belajar_laravel_database`,

-   Lalu buat table dengan nama `categories`.

    ![categories](img/categories.png)

---

### 4. Debug Query

-   Kita bisa gunakan `DB::listen()` untuk melakukan debugging SQL query yang dibuat di Laravel,

-   `DB::listen()` akan dipanggil setiap ada operasi yang dilakukan oleh Laravel Database,

-   Kita bisa me-log query misalnya, kita daftarkan `DB::listen()` pada Service Provider.

    ```PHP
    public function boot(): void
    {
        //
        DB::listen(function (QueryExecuted $query){
            Log::info($query->sql);
        });
    }
    ```

-   Nanti kita bisa melihat apa yang sudah pernah kita log di folder `storage/logs/laravel.log`.

---

### 5. CRUD SQL

-   Dengan menggunakan DB Facade, kita bisa melakukan `Raw Query` (Query ke database secara manual),

-   Function Raw SQL

    ![rawSQL](img/rawSQL.png)

-   Kode Raw SQL

    ```PHP
    protected function setUp(): void // setUp saat query dimulai maka data akan dihapus terlebih dahulu
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        DB::delete('delete from categories');
    }

    public function testCrud()
    {
        DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
            "GADGET", "Gadget", "Gadget Category", "2020-10-10 10:10:10"
        ]);

        $results = DB::select('select * from categories where id = ?',  ['GADGET']);

        self::assertCount(1, $results);
        self::assertEquals('GADGET', $results[0]->id);
        self::assertEquals('Gadget', $results[0]->name);
        self::assertEquals('Gadget Category', $results[0]->description);
        self::assertEquals("2020-10-10 10:10:10", $results[0]->created_at);
    }
    ```

-   Hasil log akan di simpan di folder `storage/logs.laravel.log`.

---

### 6. Named Binding

-   Laravel mendukung fitur bernama binding, sehingga kita bisa mengganti `?` (tanda tanya) menjadi nama parameter,

-   Dan data bisa kita kirim menggunakan _array_ dengan menggunakan _key_ sesuai nama parameter.

-   kode Named Binding

    ```PHP
    public function testCrudNamedParameter()
    {
        DB::insert('insert into categories(id, name, description, created_at) values (:id, :name, :description , :created_at)', [
            "id" => "GADGET",
            "name" => "Gadget",
            "description" => "Gadget Category",
            "created_at" => "2020-10-10 10:10:10",
        ]);

        $results = DB::select('select * from categories where id = ?',  ['GADGET']);

        self::assertCount(1, $results);
        self::assertEquals('GADGET', $results[0]->id);
        self::assertEquals('Gadget', $results[0]->name);
        self::assertEquals('Gadget Category', $results[0]->description);
        self::assertEquals("2020-10-10 10:10:10", $results[0]->created_at);
    }
    ```

---

### 7. Database Transaction

-   Laravel Database memiliki fitur untuk melakukan database transaction secara otomatis,

-   Dengan begitu, tidak perlu lagi melakukan start transaction dan commit/rollback secara manual lagi,

-   Kita bisa menggunakan _function_ `DB::transaction(function)`,

-   Didalam _function_ tersebut kita bisa melakukan perintah database, jika terjadi _error_ secara otomatis transaksi akan di _rollback_.

-   Kode Database Transaction

    ```PHP
    public function testTransactionSuccess()
    {
        DB::transaction(function () {
            DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                "GADGET", "Gadget", "Gadget Category", "2020-10-10 10:10:10"
            ]);
            DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                "FOOD", "Food", "Food Category", "2020-10-10 10:10:10"
            ]);
        });

        $results = DB::select("select * from categories");
        self::assertCount(2, $results);
    }
    ```

-   Selain menggunakan fitur otomatis, juga bisa melakukan database transaction secara manual,

-   Beberapa _function_ yang bisa digunakan:

    -   `DB::beginTransaction()` untuk memulai transaction,
    -   `DB::commit()` untuk melakukan commit transaksi,
    -   `DB::rollBack()` untuk rollback transaksi.

-   Kode Manual Transaksi

    ```PHP
    public function testTransactionFailed() // test transaksi manual gagal
    {
        try {
            DB::transaction(function () {
                DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                    "GADGET", "Gadget", "Gadget Category", "2020-10-10 10:10:10"
                ]);
                DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                    "GADGET", "Food", "Food Category", "2020-10-10 10:10:10"
                ]);
            });
        } catch (QueryException $error) {
            // expected
        }

        $results = DB::select("select * from categories");
        self::assertCount(0, $results);

    }

    public function testMaualTransactionSuccess() // test transaksi manual sukses
    {
        try {
            DB::beginTransaction();
            DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                "GADGET", "Gadget", "Gadget Category", "2020-10-10 10:10:10"
            ]);
            DB::insert('insert into categories(id, name, description, created_at) values (?, ?, ? , ?)', [
                "FOOD", "Food", "Food Category", "2020-10-10 10:10:10"
            ]);
            DB::commit();
        } catch (QueryException $error) {
            DB::rollBack();
        }

        $results = DB::select("select * from categories");
        self::assertCount(2, $results);
    }
    ```

---

### 8. Database Commands

-   Artisan Laravel memiliki banyak fitur, termasuk perintah database (db). Beberapa perintah yang dapat digunakan antara lain:

    -   `php artisan db`: mengakses terminal database, seperti MySQL,
    -   `php artisan db:table`: melihat seluruh tabel di database,
    -   `php artisan db:show`: melihat informasi database,
    -   `php artisan db:monitor`: memonitor jumlah koneksi di database,
    -   `php artisan db:seed`: menambah data di database,
    -   `php artisan db:wipe`: menghapus seluruh tabel di database.

---

### 9. Query Builder

-   Laravel memiliki fitur _Query Builder_, fitur ini sangat memmpermudah kita saat ketika ingin membuat perintah ke database dibandingkan melakukan secara manual menggunakan _Raw SQL_,

-   Untuk membuat _Query Builder_ bisa menggunakan _function_ `DB::table(nama)`.

-   Untuk melakukan insert _Query Builder_, kita bisa menggunakan method dengan prefix insert dengan parameter `assosiative array` dimana _key_ nya adalah kolom, dan value nya adalah nilai yang akan disimpan di database.

-   `insert() `untuk memasukkan data ke database, _throw exception_ jika terjadi _error_ misal duplicate primary key.

-   `insertGetId()` untuk memasukkan dÃ¥ta ke database, dan mengembalikan primary key yang diset
    secara auto generate, cocok untuk tabel dengan id auto increment

-   `insertOrIgnore()` untuk memasukkan data ke database, dan jika terjadi _error_, maka akan di ignore

-   kode Query Builder

    ```PHP
     public function testInsert()
    {
        DB::table("categories")->insert([
            "id" => "GADGET",
            "name" => "Gadget"
        ]);
        DB::table("categories")->insert([
            "id" => "FOOD",
            "name" => "Food"
        ]);

        $result = DB::select("select count(id) as total from categories");
        self::assertEquals(2, $result[0]->total);
    }
    ```

---

### 10. Query builder Select

-   Beberapa perintah _Query Builder Select_:

    -   `get(columns)` untuk mengambil seluruh data, defaultnya semua kolom diambil,
    -   `first(columns)` untuk mengambil data pertama, defaultnya semua kolom diambil,
    -   `pluck(columns)` untuk mengambil salah satu kolom saja,

-   Hasil dari _Query Builder Select_ adalah Laravel Collection.

-   Kode Query Builder Select

    ```PHP
     public function testSelect()
    {
        $this->testInsert();

        $collection = DB::table("categories")->select(["id", "name"])->get();
        self::assertNotNull($collection);

        $collection->each(function ($item) {
            Log::info(json_encode($item));
        });
    }
    ```

---

### 11. Query builder Where

-   Untuk menambahakan _Where_ di _Query Builder_, bisa menggunakan banyak sekali method.

-   Method Where

    ![methodWhere](img/methodWhere.png)

-   Kode Insert Category

    ```PHP
    public function insertCategories(){
        DB::table("categories")->insert([
            "id" => "SMARTPHONE",
            "name" => "smartphone",
            "created_at" => "2024-05-21:15:00",
        ]);
        DB::table("categories")->insert([
            "id" => "FOOD",
            "name" => "food",
            "created_at" => "2024-05-21:15:00",
        ]);
        DB::table("categories")->insert([
            "id" => "LAPTOP",
            "name" => "laptop",
            "created_at" => "2024-05-21:15:00",
        ]);
        DB::table("categories")->insert([
            "id" => "FASION",
            "name" => "fasion",
            "created_at" => "2024-05-21:15:00",
        ]);
    }
    ```

-   Kode Where Method

    ```PHP
       public function testWhere()
    {
        $this->insertCayegories();

        DB::table("categories")->where(function(builder $builder){
            $builder->where('id', '=', 'SMARTPHONE');
            $builder->orWhere('id', '=', 'SMARTPHONE');
        })->get();

        self::assertCount(2, $collection);
        $collection->each(function($item){
            Log::info(json_encode($item));
        });
    }
    ```

---

### 12. Query Builder Update

-   Untuk melakukan update, bisa menggunakan method `update(array)`,

-   Dimana parameternya kita bisa mengirim assosiative array yang berisi kolom -> value.

-   kode Query Builder Update

    ```PHP
    public function testUpdate()
    {
        $this->insertCategories();

        DB::table("categories")->where("id", "=", "SMARTPHONE")->update([
            "name" => "Handphone"
        ]);

        $collection = DB::table("categories")->where("name", "=", "Handphone")->get();
        self::assertCount(1, $collection);
        $collection->each(function ($item) {
            Log::info(json_encode($item));
        });
    }
    ```
---

### 13. 

---

## PERTANYAAN & CATATAN TAMBAHAN

-   Tidak ada

---

### KESIMPULAN

-   Pembelajaran Laravel Database mencakup berbagai aspek penting dalam menggunakan database di Laravel. Mengajarkan cara mengonfigurasi database, membuat dan menjalankan migrasi, menggunakan Eloquent ORM untuk berinteraksi dengan tabel, dan membuat query database yang efisien. Selain itu, dijelaskan juga tentang validasi data, relasi antar tabel, dan pengelolaan data dengan CRUD (Create, Read, Update, Delete) operations
